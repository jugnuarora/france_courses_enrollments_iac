id: 02_courses_enrollments_pipeline
namespace: french-courses-enrollments

inputs:
  - id: courses_or_enrollments
    type: SELECT
    displayName: Select if you want to download courses or enrollments
    values: [courses, enrollments]
    defaults: courses

variables:
  today: "{{ now() | date('yyyy_MM_dd') }}"
  gcs_core: "gs://{{kv('GCP_BUCKET_NAME')}}/courses_enrol_data_{{vars.today}}"
  gcs_core_folder: "courses_enrol_data_{{vars.today}}"
  gcs_courses_raw: "{{vars.gcs_core}}/courses_raw_parquet/*.parquet"
  gcs_courses_filtered: "{{vars.gcs_core}}/courses_filtered"
  gcs_enrollments_raw: "{{vars.gcs_core}}/enrollments_raw_parquet/*.parquet"
  gcs_enrollments_filtered: "{{vars.gcs_core}}/enrollments_filtered"
  gcs_formacode_translated: "gs://{{kv('GCP_BUCKET_NAME')}}/formacode_translated"

tasks:
  - id: set_label
    type: io.kestra.plugin.core.execution.Labels
    labels:
      c/e: "{{inputs.courses_or_enrollments}}"

  - id: if_courses
    type: io.kestra.plugin.core.flow.If
    condition: "{{inputs.courses_or_enrollments == 'courses'}}"
    then:
      - id: delete_gcs_folders_c
        type: io.kestra.plugin.core.flow.ForEach
        values:
          - "{{render(vars.gcs_core)}}/courses_raw_parquet/"
          - "{{render(vars.gcs_core)}}/courses_filtered/"
        tasks:
          - id: delete_single_folder_c
            type: io.kestra.plugin.gcp.gcs.DeleteList
            from: "{{ taskrun.value }}"

      - id: workingDirectory_c
        type: io.kestra.plugin.core.flow.WorkingDirectory
        tasks:
        - id: cloneRepository_c
          type: io.kestra.plugin.git.Clone
          url: https://github.com/jugnuarora/france_courses_enrollments.git
          branch: main
        
        - id: pythonScript_c
          type: io.kestra.plugin.scripts.python.Commands
          warningOnStdErr: false
          docker:
            image: ghcr.io/kestra-io/pydata:latest
          beforeCommands:
            - pip install -r requirements.txt > /dev/null
            - cd scripts
            - mkdir -p .dlt
            - echo "[destination.filesystem]" > .dlt/secrets.toml
            - echo "bucket_url = \"gs://{{ kv('GCP_BUCKET_NAME') }}\"" >> .dlt/secrets.toml
            - echo "[destination.filesystem.credentials]" >> .dlt/secrets.toml
            - echo "project_id = \"{{ kv('GCP_PROJECT_ID') }}\"" >> .dlt/secrets.toml
            - echo "private_key = \"\"\"{{ kv('GCP_CREDS')['private_key'] }}\"\"\"" >> .dlt/secrets.toml
            - echo "client_email = \"{{ kv('GCP_CREDS')['client_email'] }}\"" >> .dlt/secrets.toml
          commands:
            - python 01_courses_data_upload.py --output {{render(vars.gcs_core_folder)}}

        - id: spark_job_c
          type: io.kestra.plugin.spark.SparkCLI
          inputFiles:
            gcs.json: "{{ kv('GCP_CREDS') }}" # Read GCP credentials from KV store
          docker:
            image: bitnami/spark
          commands:
            - /opt/bitnami/spark/bin/spark-submit --jars ./lib/gcs-connector-hadoop3-2.2.5.jar --name GCS_Spark_Job --master local[*] ./scripts/03_courses_spark.py --input {{render(vars.gcs_courses_raw)}} --output {{render(vars.gcs_courses_filtered)}}

      - id: bq_courses_creation
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          CREATE TABLE IF NOT EXISTS `{{kv('GCP_PROJECT_ID')}}.source_tables.courses`
          (
            unique_row_id BYTES OPTIONS (description = 'A unique identifier for the trip, generated by hashing key trip attributes.'),
            date_extract DATE OPTIONS (description = 'Dataset upload date. Example: 2025-03-19'),
            provider STRING OPTIONS (description = 'company providing the course. Example: AFTRAL'),
            department STRING OPTIONS (description = 'name of the department of the training location. Example: Gironde'),
            region STRING OPTIONS (description = 'name of the region of the training location. Example: New Aquitaine'),
            type_referential STRING OPTIONS (description = '"RS" for certifications registered in the Specific Directory, "RNCP" for certifications registered in the RNCP, empty for legislative exceptions or when the certification is not active in the training catalog. Example: RS'),
            code_rs INTEGER OPTIONS (description = 'Certifications listed in the RS inventory. Example: 7041'),
            code_rncp INTEGER OPTIONS (description = 'National Directory of Professional Certifications Code. Example: -1 (Because it has code_rs)'),
            certification_title STRING OPTIONS (description = 'Certification Title. Example: Certificate of aptitude for safe driving (CACES) Recommendation 482 category B1: Sequential movement extraction equipment'),
            training_exit_level STRING OPTIONS (description = 'level of training.'),
            code_formacode_1 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31025 - Data Analytics, 31026 - Data Science'),
            code_formacode_2 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31028 - Artificial Intelligence'),
            code_formacode_3 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 331035 - Data Visualization'),
            code_formacode_4 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31052 - Data Warehouse, 31023 - big data'),
            code_formacode_5 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31054 - Computer Science & Information Systems'),
            main_formacode_desc STRING OPTIONS (description = 'Main Formacode Label corresponding to code_formacode_1. The whole list of codes is at '),
            code_rome_1 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset. Example: M1805 - Computer Studies and Development'),
            code_rome_2 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            code_rome_3 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            code_rome_4 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            code_rome_5 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            nsf_code_1_desc STRING OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: Communication and Information'),
            nsf_code_2_desc STRING OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: Communication and Information'),
            nsf_code_3_desc STRING OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: Communication and Information'),
            nsf_code_1 INTEGER OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: 326'),
            nsf_code_2 INTEGER OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: 321'),
            nsf_code_3 INTEGER OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: 320'),
            code_certification INTEGER OPTIONS (description = 'Certification code corresponding to certification_title. Example: 106655'),
            provider_id INTEGER OPTIONS (description = 'Establishment unique ID corresponding to provider. Example: 30540504500603'),
            training_id STRING OPTIONS (description = 'Trianing Id. Example: 30540504500603_ENCH22-14452-RS7041'),
            training_title STRING OPTIONS (description = 'Trianing title. Example: Construction Machinery Training CACES® R482 Cat. B1 Experienced'),
            strong_points STRING OPTIONS (description = 'Supplement to the expected training results. Example: Qualified professionals. We offer infrastructure and equipment to replicate real-life working conditions and enable you to obtain CACES certification in other categories. Please contact us.'),
            training_objective STRING OPTIONS (description = 'Description of training objectives. Example: Example: Update the theoretical knowledge and practical know-how necessary for the safe operation of construction machinery'),
            training_content STRING OPTIONS (description = 'Description of the training content'),
            expected_training_results STRING OPTIONS (description = 'Description of the expected results of the training. Example: Certificate of aptitude for safe driving (CACES®) for construction machinery in the category concerned, if the result is positive in accordance with CNAMTS Recommendation R 482'),
            trianing_module_count INTEGER OPTIONS (description = 'Number of separate training actions for the training concerned. Example: 2'),
            nb_session_active INTEGER OPTIONS (description = 'Number of active sessions for the training concerned. Example: 2'),
            nb_remote_session INTEGER OPTIONS (description = 'Number of sessions open for registration, with a remote attendance option. Example: 0'),
            duration_min INTEGER OPTIONS (description = 'Minimum of the total number of hours of the actions concerned. Example: 14'),
            duration_max INTEGER OPTIONS (description = 'Maximum of the total number of hours of the actions concerned. Example: 14'),
            duration_mean INTEGER OPTIONS (description = 'Average of the total number of hours of the actions concerned. Example: 14'),
            fees_min NUMERIC OPTIONS (description = 'Minimum fees including all taxes for the actions concerned. Example: 790.8'),
            fees_max NUMERIC OPTIONS (description = 'Maximum fees including all taxes for the actions concerned. Example: 790.8'),
            fees_mean NUMERIC OPTIONS (description = 'Average fees including all taxes for the actions concerned. Example: 790.8'),
            department_code STRING OPTIONS (description = 'Department code of the training location corresponding to the field department. Example: 33'),
            region_code STRING OPTIONS (description = 'Training location region code corresponding to the field Region. Example: 75'),
            nb_hours INTEGER OPTIONS (description = 'Sum of the hourly volumes available for training. Example: 540'),
            coderegion_export STRING OPTIONS (description = 'Training location region code. Example: 75')
          )
          PARTITION BY date_extract
          CLUSTER BY code_formacode_1;

      - id: bq_courses_ext
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          CREATE OR REPLACE EXTERNAL TABLE `{{kv('GCP_PROJECT_ID')}}.external.courses_ext`
          (
            date_extract DATE OPTIONS (description = 'Dataset upload date. Example: 2025-03-19'),
            nom_of STRING OPTIONS (description = 'company providing the course. Example: AFTRAL'),
            nom_departement STRING OPTIONS (description = 'name of the department of the training location. Example: Gironde'),
            nom_region STRING OPTIONS (description = 'name of the region of the training location. Example: New Aquitaine'),
            type_referentiel STRING OPTIONS (description = '"RS" for certifications registered in the Specific Directory, "RNCP" for certifications registered in the RNCP, empty for legislative exceptions or when the certification is not active in the training catalog. Example: RS'),
            code_inventaire INTEGER OPTIONS (description = 'Certifications listed in the RS inventory. Example: 7041'),
            code_rncp INTEGER OPTIONS (description = 'National Directory of Professional Certifications Code. Example: -1 (Because it has code_rs)'),
            intitule_certification STRING OPTIONS (description = 'Certification Title. Example: Certificate of aptitude for safe driving (CACES) Recommendation 482 category B1: Sequential movement extraction equipment'),
            libelle_niveau_sortie_formation STRING OPTIONS (description = 'level of training.'),
            code_formacode_1 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31025 - Data Analytics, 31026 - Data Science'),
            code_formacode_2 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31028 - Artificial Intelligence'),
            code_formacode_3 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 331035 - Data Visualization'),
            code_formacode_4 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31052 - Data Warehouse, 31023 - big data'),
            code_formacode_5 INTEGER OPTIONS (description = 'It represents the 5 most relevant Formacode codes for each training course. It is like a search word or a classification system to categorise training programs by skills it aims at. Example: 31054 - Computer Science & Information Systems'),
            libelle_code_formacode_principal STRING OPTIONS (description = 'Main Formacode Label corresponding to code_formacode_1. The whole list of codes is at '),
            code_rome_1 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset. Example: M1805 - Computer Studies and Development'),
            code_rome_2 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            code_rome_3 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            code_rome_4 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            code_rome_5 STRING OPTIONS (description = 'These codes are used to classify the different types of jobs and skills associated with each training program, helping users identify the employment opportunities related to the courses listed in the dataset.'),
            libelle_nsf_1 STRING OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: Communication and Information'),
            libelle_nsf_2 STRING OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: Communication and Information'),
            libelle_nsf_3 STRING OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: Communication and Information'),
            code_nsf_1 INTEGER OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: 326'),
            code_nsf_2 INTEGER OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: 321'),
            code_nsf_3 INTEGER OPTIONS (description = 'Training Specialties Nomenclature Data – one label per column for ease of use. Maximum 3 labels for one training course. Example: 320'),
            code_certifinfo INTEGER OPTIONS (description = 'Certification code corresponding to certification_title. Example: 106655'),
            siret INTEGER OPTIONS (description = 'Establishment unique ID corresponding to provider. Example: 30540504500603'),
            numero_formation STRING OPTIONS (description = 'Trianing Id. Example: 30540504500603_ENCH22-14452-RS7041'),
            intitule_formation STRING OPTIONS (description = 'Trianing title. Example: Construction Machinery Training CACES® R482 Cat. B1 Experienced'),
            points_forts STRING OPTIONS (description = 'Supplement to the expected training results. Example: Qualified professionals. We offer infrastructure and equipment to replicate real-life working conditions and enable you to obtain CACES certification in other categories. Please contact us.'),
            objectif_formation STRING OPTIONS (description = 'Description of training objectives. Example: Example: Update the theoretical knowledge and practical know-how necessary for the safe operation of construction machinery'),
            contenu_formation STRING OPTIONS (description = 'Description of the training content'),
            resultats_attendus_formation STRING OPTIONS (description = 'Description of the expected results of the training. Example: Certificate of aptitude for safe driving (CACES®) for construction machinery in the category concerned, if the result is positive in accordance with CNAMTS Recommendation R 482'),
            nb_action INTEGER OPTIONS (description = 'Number of separate training actions for the training concerned. Example: 2'),
            nb_session_active INTEGER OPTIONS (description = 'Number of active sessions for the training concerned. Example: 2'),
            nb_session_a_distance INTEGER OPTIONS (description = 'Number of sessions open for registration, with a remote attendance option. Example: 0'),
            nombre_heures_total_min INTEGER OPTIONS (description = 'Minimum of the total number of hours of the actions concerned. Example: 14'),
            nombre_heures_total_max INTEGER OPTIONS (description = 'Maximum of the total number of hours of the actions concerned. Example: 14'),
            nombre_heures_total_mean INTEGER OPTIONS (description = 'Average of the total number of hours of the actions concerned. Example: 14'),
            frais_ttc_tot_min NUMERIC OPTIONS (description = 'Minimum fees including all taxes for the actions concerned. Example: 790.8'),
            frais_ttc_tot_max NUMERIC OPTIONS (description = 'Maximum fees including all taxes for the actions concerned. Example: 790.8'),
            frais_ttc_tot_mean NUMERIC OPTIONS (description = 'Average fees including all taxes for the actions concerned. Example: 790.8'),
            code_departement STRING OPTIONS (description = 'Department code of the training location corresponding to the field department. Example: 33'),
            code_region STRING OPTIONS (description = 'Training location region code corresponding to the field Region. Example: 75'),
            nbaction_nbheures INTEGER OPTIONS (description = 'Sum of the hourly volumes available for training. Example: 540'),
            coderegion_export STRING OPTIONS (description = 'Training location region code. Example: 75')
          )
          OPTIONS (
              format = 'parquet',
              uris = ["{{render(vars.gcs_courses_filtered)}}/*.parquet"]
          );

      - id: bq_courses_tmp
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          CREATE OR REPLACE TABLE `{{kv('GCP_PROJECT_ID')}}.external.courses_latest`
          AS
          SELECT
            MD5(CONCAT(
              COALESCE(CAST(date_extract AS STRING), ""),
              COALESCE(CAST(siret AS STRING), ""),
              COALESCE(CAST(nom_departement AS STRING), ""),
              COALESCE(CAST(numero_formation AS STRING), "")
            )) AS unique_row_id,
            *
          FROM `{{kv('GCP_PROJECT_ID')}}.external.courses_ext`;

      - id: bq_courses_merge
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          MERGE INTO `{{kv('GCP_PROJECT_ID')}}.source_tables.courses` T
          USING `{{kv('GCP_PROJECT_ID')}}.external.courses_latest` AS S
          ON T.unique_row_id = S.unique_row_id
          WHEN NOT MATCHED THEN
            INSERT (unique_row_id, date_extract, provider, department, region, type_referential, code_rs, code_rncp, certification_title, training_exit_level, code_formacode_1, code_formacode_2, code_formacode_3, code_formacode_4, code_formacode_5, main_formacode_desc, code_rome_1, code_rome_2, code_rome_3, code_rome_4, code_rome_5, nsf_code_1_desc, nsf_code_2_desc, nsf_code_3_desc, nsf_code_1, nsf_code_2, nsf_code_3, code_certification, provider_id, training_id, training_title, strong_points, training_objective, training_content, expected_training_results, trianing_module_count, nb_session_active, nb_remote_session, duration_min, duration_max, duration_mean, fees_min, fees_max, fees_mean, department_code, region_code, nb_hours, coderegion_export)
            VALUES (S.unique_row_id, S.date_extract, S.nom_of, S.nom_departement, S.nom_region, S.type_referentiel, S.code_inventaire, S.code_rncp, S.intitule_certification, S.libelle_niveau_sortie_formation, S.code_formacode_1, S.code_formacode_2, S.code_formacode_3, S.code_formacode_4, S.code_formacode_5, S.libelle_code_formacode_principal, S.code_rome_1, S.code_rome_2, S.code_rome_3, S.code_rome_4, S.code_rome_5, S.libelle_nsf_1, S.libelle_nsf_2, S.libelle_nsf_3, S.code_nsf_1, S.code_nsf_2, S.code_nsf_3, S.code_certifinfo, S.siret, S.numero_formation, S.intitule_formation, S.points_forts, S.objectif_formation, S.contenu_formation, S.resultats_attendus_formation, S.nb_action, S.nb_session_active, S.nb_session_a_distance, S.nombre_heures_total_min, S.nombre_heures_total_max, S.nombre_heures_total_mean, S.frais_ttc_tot_min, S.frais_ttc_tot_max, S.frais_ttc_tot_mean, S.code_departement, S.code_region, S.nbaction_nbheures, S.coderegion_export);

  - id: if_enrollments
    type: io.kestra.plugin.core.flow.If
    condition: "{{inputs.courses_or_enrollments == 'enrollments'}}"
    then:
      - id: delete_gcs_folders_e
        type: io.kestra.plugin.core.flow.ForEach
        values:
          - "{{render(vars.gcs_core)}}/enrollments_raw_parquet/"
          - "{{render(vars.gcs_core)}}/enrollments_filtered/"
        tasks:
          - id: delete_single_folder_e
            type: io.kestra.plugin.gcp.gcs.DeleteList
            from: "{{ taskrun.value }}"

      - id: workingDirectory_e
        type: io.kestra.plugin.core.flow.WorkingDirectory
        tasks:
        - id: cloneRepository_e
          type: io.kestra.plugin.git.Clone
          url: https://github.com/jugnuarora/france_courses_enrollments.git
          branch: main
        
        - id: pythonScript_e
          type: io.kestra.plugin.scripts.python.Commands
          warningOnStdErr: false
          docker:
            image: ghcr.io/kestra-io/pydata:latest
          beforeCommands:
            - pip install -r requirements.txt > /dev/null
            - cd scripts
            - mkdir -p .dlt
            - echo "[destination.filesystem]" > .dlt/secrets.toml
            - echo "bucket_url = \"gs://{{ kv('GCP_BUCKET_NAME') }}\"" >> .dlt/secrets.toml
            - echo "[destination.filesystem.credentials]" >> .dlt/secrets.toml
            - echo "project_id = \"{{ kv('GCP_PROJECT_ID') }}\"" >> .dlt/secrets.toml
            - echo "private_key = \"\"\"{{ kv('GCP_CREDS')['private_key'] }}\"\"\"" >> .dlt/secrets.toml
            - echo "client_email = \"{{ kv('GCP_CREDS')['client_email'] }}\"" >> .dlt/secrets.toml
          commands:
            - python 02_enrollments_data_upload.py --output {{render(vars.gcs_core_folder)}}

        - id: spark_job_e
          type: io.kestra.plugin.spark.SparkCLI
          inputFiles:
            gcs.json: "{{ kv('GCP_CREDS') }}" # Read GCP credentials from KV store
          docker:
            image: bitnami/spark
          commands:
            - /opt/bitnami/spark/bin/spark-submit --jars ./lib/gcs-connector-hadoop3-2.2.5.jar --name GCS_Spark_Job --master local[*] ./scripts/04_enrollments_spark.py --input {{render(vars.gcs_enrollments_raw)}} --output {{render(vars.gcs_enrollments_filtered)}}

      - id: bq_enrollments_creation
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          CREATE TABLE IF NOT EXISTS `{{kv('GCP_PROJECT_ID')}}.source_tables.enrollments`
          (
            unique_row_id BYTES OPTIONS (description = 'A unique identifier for the trip, generated by hashing key trip attributes.'),
            year_month DATE OPTIONS (description = 'year_month of entry or exit. Example: 2024-11'),
            year INTEGER OPTIONS (description = 'year of entry or exit of trainings. Example: 2024'),
            month INTEGER OPTIONS (description = 'month of entry or exit of tranings. Example: 11'),
            type_referential STRING OPTIONS (description = '"RS" for certifications registered in the Specific Directory, "RNCP" for certifications registered in the RNCP, empty for legislative exceptions or when the certification is not active in the training catalog. Example: RS'),
            code_rncp INTEGER OPTIONS (description = 'If completed (different from -1), it indicates a certification registered in the National Directory of Professional Certifications. The RNCP lists all professional qualifications recognized by the State, i.e. "vocational" training. Example: -1'),
            code_rs INTEGER OPTIONS (description = 'If filled in (different from -1), it indicates a certification registered in the Specific Directory. The RS groups together skills complementary to professional certifications. This includes regulatory obligations, cross-disciplinary skills certifications, and certifications complementary to a profession. Example: 5055'),
            code_certification INTEGER OPTIONS (description = 'The certification code in the Certif Info reference system of the CARIF-OREF network and ONISEP. Example: 106691'),
            certification_title STRING OPTIONS (description = "The title of the certification. Example: Certificat d'aptitude à conduire en sécurité (CACES) - Recommandation 489 catégorie 1A : Transpalettes à conducteur porté sans élévation du poste de conduite"),
            provider_id INTEGER OPTIONS (description = 'Establishment unique ID corresponding to provider. Example: 45331683800045'),
            provider STRING OPTIONS (description = 'OLIVIER DUPEYRE FORMATION'),
            training_entries INTEGER OPTIONS (description = 'Volume of trainees having started their training according to the date of entry into training declared by the training organization. Example: 4'),
            partial_completion_exits INTEGER OPTIONS (description = 'Volume of trainees who completed their training without having followed it in full based on the training completion date declared by the training organization. Example: 0'),
            total_completion_exits INTEGER OPTIONS (description = 'Volume of trainees having completed their training by following it in full according to the training completion date declared by the training organization. Example: 4'),
            load_date DATE OPTIONS (description = 'date when reported by the provider. Example: 2025-03-03')
          )
          PARTITION BY year_month
          CLUSTER BY provider;

      - id: bq_enrollments_ext
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          CREATE OR REPLACE EXTERNAL TABLE `{{kv('GCP_PROJECT_ID')}}.external.enrollments_ext`
          (
            annee_mois DATE OPTIONS (description = 'year_month of entry or exit. Example: 2024-11'),
            annee INTEGER OPTIONS (description = 'year of entry or exit of trainings. Example: 2024'),
            mois INTEGER OPTIONS (description = 'month of entry or exit of tranings. Example: 11'),
            type_referentiel STRING OPTIONS (description = '"RS" for certifications registered in the Specific Directory, "RNCP" for certifications registered in the RNCP, empty for legislative exceptions or when the certification is not active in the training catalog. Example: RS'),
            code_rncp INTEGER OPTIONS (description = 'If completed (different from -1), it indicates a certification registered in the National Directory of Professional Certifications. The RNCP lists all professional qualifications recognized by the State, i.e. "vocational" training. Example: -1'),
            code_rs INTEGER OPTIONS (description = 'If filled in (different from -1), it indicates a certification registered in the Specific Directory. The RS groups together skills complementary to professional certifications. This includes regulatory obligations, cross-disciplinary skills certifications, and certifications complementary to a profession. Example: 5055'),
            code_certifinfo INTEGER OPTIONS (description = 'The certification code in the Certif Info reference system of the CARIF-OREF network and ONISEP. Example: 106691'),
            intitule_certification STRING OPTIONS (description = "The title of the certification. Example: Certificat d'aptitude à conduire en sécurité (CACES) - Recommandation 489 catégorie 1A : Transpalettes à conducteur porté sans élévation du poste de conduite"),
            siret_of_contractant INTEGER OPTIONS (description = 'Establishment unique ID corresponding to provider. Example: 45331683800045'),
            raison_sociale_of_contractant STRING OPTIONS (description = 'OLIVIER DUPEYRE FORMATION'),
            entrees_formation INTEGER OPTIONS (description = 'Volume of trainees having started their training according to the date of entry into training declared by the training organization. Example: 4'),
            sorties_realisation_partielle INTEGER OPTIONS (description = 'Volume of trainees who completed their training without having followed it in full based on the training completion date declared by the training organization. Example: 0'),
            sorties_realisation_totale INTEGER OPTIONS (description = 'Volume of trainees having completed their training by following it in full according to the training completion date declared by the training organization. Example: 4'),
            date_chargement DATE OPTIONS (description = 'date when reported by the provider. Example: 2025-03-03')
          )
          OPTIONS (
              format = 'parquet',
              uris = ["{{render(vars.gcs_enrollments_filtered)}}/*.parquet"]
          );
      
      - id: bq_enrollments_tmp
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          CREATE OR REPLACE TABLE `{{kv('GCP_PROJECT_ID')}}.external.enrollments_latest`
          AS
          SELECT
            MD5(CONCAT(
              COALESCE(CAST(annee_mois AS STRING), ""),
              COALESCE(CAST(code_certifinfo AS STRING), ""),
              COALESCE(CAST(intitule_certification AS STRING), ""),
              COALESCE(CAST(siret_of_contractant AS STRING), ""),
              COALESCE(CAST(raison_sociale_of_contractant AS STRING), ""),
              COALESCE(CAST(code_rncp AS STRING), ""),
              COALESCE(CAST(code_rs AS STRING), "")
            )) AS unique_row_id,
            *
          FROM `{{kv('GCP_PROJECT_ID')}}.external.enrollments_ext`;

      - id: bq_enrollments_merge
        type: io.kestra.plugin.gcp.bigquery.Query
        sql: |
          MERGE INTO `{{kv('GCP_PROJECT_ID')}}.source_tables.enrollments` T
          USING `{{kv('GCP_PROJECT_ID')}}.external.enrollments_latest` AS S
          ON T.unique_row_id = S.unique_row_id
          WHEN NOT MATCHED THEN
            INSERT (unique_row_id, year_month, year, month, type_referential, code_rncp, code_rs, code_certification, certification_title, provider_id, provider, training_entries, partial_completion_exits, total_completion_exits, load_date)
            VALUES (S.unique_row_id, S.annee_mois, S.annee, S.mois, S.type_referentiel, S.code_rncp, S.code_rs, S.code_certifinfo, S.intitule_certification, S.siret_of_contractant, S.raison_sociale_of_contractant, S.entrees_formation, S.sorties_realisation_partielle, S.sorties_realisation_totale, S.date_chargement);
          
  - id: purge_files
    type: io.kestra.plugin.core.storage.PurgeCurrentExecutionFiles
    description: If you'd like to explore Kestra outputs, disable it.
    disabled: false

triggers:
  - id: courses_trigger
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "00 21 5 * *" # 0 minutes, 23 hours, 5th day of month, every month, every day of week
    inputs:
      courses_or_enrollments: courses

  - id: enrollments_trigger
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "00 21 5 * *" # 0 minutes, 23 hours, 5th day of month, every month, every day of week
    inputs:
      courses_or_enrollments: enrollments


pluginDefaults:
  - type: io.kestra.plugin.gcp
    values:
      serviceAccount: "{{ kv('GCP_CREDS') }}"
      projectId: "{{ kv('GCP_PROJECT_ID') }}"
      location: "{{ kv('GCP_LOCATION') }}"
      bucket: "{{ kv('GCP_BUCKET_NAME') }}"